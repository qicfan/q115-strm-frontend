# 数据库备份和恢复功能 API 文档

## 功能概述

数据库备份和恢复功能提供了完整的数据安全保障机制，支持手动和定时自动备份、一键恢复、备份文件管理等功能。

### 核心特性

- ✅ **定时自动备份**: 支持cron表达式配置定时备份，最小间隔1小时
- ✅ **手动备份**: 随时手动触发备份任务
- ✅ **一键恢复**: 上传备份文件恢复数据库，自动创建回滚备份
- ✅ **进度监控**: 实时查询备份任务进度（状态、百分比、时间预估）
- ✅ **智能清理**: 按时间和数量双重限制自动清理旧备份
- ✅ **维护模式**: 恢复时自动进入维护模式，防止数据冲突
- ✅ **任务取消**: 支持取消正在运行的备份任务
- ✅ **历史记录**: 完整的备份历史记录和元数据管理

### 约束和限制

1. **同时只能有一个备份任务运行**
2. **备份任务最长执行时间：1小时**
3. **维护模式最长持续时间：1小时**
4. **定时备份最小间隔：1小时**
5. **备份文件格式：.sql 或 .sql.gz**
6. **备份文件大小限制：1GB**

---

## API 接口列表

### 基础信息

- **Base URL**: `/api/database`
- **认证方式**: JWT Token（通过 `Authorization: Bearer <token>` 请求头）
- **响应格式**: JSON

#### 通用响应格式

```json
{
  "code": 200,           // 200: 成功, 400: 失败
  "message": "操作成功",  // 消息提示
  "data": {}             // 响应数据
}
```

---

## 1. 备份配置管理

### 1.1 获取备份配置

**接口**: `GET /api/database/backup-config`

**描述**: 获取当前的备份配置信息

**请求参数**: 无

**响应示例**:

```json
{
  "code": 200,
  "message": "获取备份配置成功",
  "data": {
    "exists": true,
    "config": {
      "id": 1,
      "backup_enabled": 1,          // 0: 禁用, 1: 启用
      "backup_cron": "0 2 * * *",   // Cron表达式（每天凌晨2点）
      "backup_path": "config/backups/",  // 备份存储路径
      "backup_retention": 7,        // 保留天数
      "backup_max_count": 10,       // 最多保留数量
      "backup_compress": 1,         // 0: 不压缩, 1: 压缩
      "maintenance_mode": 0,        // 0: 正常, 1: 维护模式
      "maintenance_mode_time": 0,   // 进入维护模式的时间戳
      "created_at": 1706000000,
      "updated_at": 1706000000
    }
  }
}
```

**配置不存在时**:
```json
{
  "code": 200,
  "message": "获取备份配置成功",
  "data": {
    "exists": false
  }
}
```

---

### 1.2 更新备份配置

**接口**: `POST /api/database/backup-config`

**描述**: 更新备份配置，首次调用时自动创建配置记录

**请求参数**:

```json
{
  "backup_enabled": 1,              // 必填: 0或1
  "backup_cron": "0 2 * * *",       // 必填: Cron表达式
  "backup_path": "config/backups/", // 必填: 备份路径
  "backup_retention": 7,            // 必填: 保留天数（建议7-30）
  "backup_max_count": 10,           // 必填: 最大备份数（建议5-20）
  "backup_compress": 1              // 必填: 0或1
}
```

**Cron表达式说明**:
```
格式: * * * * *
     ┬ ┬ ┬ ┬ ┬
     │ │ │ │ │
     │ │ │ │ └─ 星期几 (0-6, 0=星期日)
     │ │ │ └─── 月份 (1-12)
     │ │ └───── 日期 (1-31)
     │ └─────── 小时 (0-23)
     └───────── 分钟 (0-59)

示例:
"0 2 * * *"     - 每天凌晨2点
"0 */4 * * *"   - 每4小时
"0 0 * * 0"     - 每周日凌晨
"0 3 1 * *"     - 每月1号凌晨3点
```

**验证规则**:
- Cron表达式必须有效
- 最小间隔必须≥1小时
- 所有字段必填

**响应示例**:

```json
{
  "code": 200,
  "message": "备份配置更新成功",
  "data": null
}
```

**错误响应**:
```json
{
  "code": 400,
  "message": "cron表达式格式无效",
  "data": null
}
```

```json
{
  "code": 400,
  "message": "备份任务定时最小间隔为1小时",
  "data": null
}
```

**前端注意事项**:
1. 更新配置后会自动重启定时任务
2. 如果系统处于维护模式，配置更新操作会被拒绝
3. 建议提供Cron表达式可视化编辑器

---

## 2. 备份任务管理

### 2.1 启动手动备份

**接口**: `POST /api/database/backup/start`

**描述**: 启动一个手动备份任务

**请求参数**:

```json
{
  "reason": "手动备份数据库"  // 必填: 备份原因说明
}
```

**响应示例**:

```json
{
  "code": 200,
  "message": "备份任务已启动",
  "data": {
    "task_id": 15  // 任务ID，用于查询进度
  }
}
```

**错误响应**:
```json
{
  "code": 400,
  "message": "已有备份任务正在运行中，请等待完成",
  "data": null
}
```

```json
{
  "code": 400,
  "message": "未找到备份配置，请先配置",
  "data": null
}
```

**前端注意事项**:
1. 启动备份后应立即轮询查询进度
2. 备份期间禁用启动备份按钮
3. 显示备份原因输入框，限制50字符

---

### 2.2 查询备份进度

**接口**: `GET /api/database/backup/progress`

**描述**: 查询当前正在运行的备份任务进度

**请求参数**: 无

**响应示例（有任务运行中）**:

```json
{
  "code": 200,
  "message": "获取进度成功",
  "data": {
    "running": true,
    "status": "running",           // running: 运行中
    "progress": 65,                // 进度百分比 0-100
    "elapsed_seconds": 120,        // 已耗时间（秒）
    "estimated_seconds": 300,      // 预计总耗时（秒）
    "current_step": "正在压缩备份文件...",  // 当前步骤描述
    "processed_tables": 13,        // 已处理表数
    "total_tables": 20             // 总表数
  }
}
```

**响应示例（无任务运行）**:

```json
{
  "code": 200,
  "message": "没有运行中的备份任务",
  "data": {
    "running": false
  }
}
```

**任务状态说明**:
- `running`: 运行中
- `completed`: 已完成
- `cancelled`: 已取消
- `timeout`: 超时
- `failed`: 失败

**前端注意事项**:
1. 建议每2-3秒轮询一次
2. 显示进度条、已耗时间、预计剩余时间
3. 显示当前步骤和表处理进度
4. 任务完成或失败时停止轮询

---

### 2.3 取消备份任务

**接口**: `POST /api/database/backup/cancel`

**描述**: 取消正在运行的备份任务

**请求参数**:

```json
{
  "task_id": 15  // 必填: 任务ID
}
```

**响应示例**:

```json
{
  "code": 200,
  "message": "备份任务已取消",
  "data": null
}
```

**错误响应**:
```json
{
  "code": 400,
  "message": "任务不存在",
  "data": null
}
```

```json
{
  "code": 400,
  "message": "只能取消运行中的任务",
  "data": null
}
```

**前端注意事项**:
1. 提供二次确认对话框
2. 取消后会删除不完整的备份文件
3. 取消后的任务会标记为"已取消"状态

---

## 3. 数据库恢复

### 3.1 上传备份文件恢复数据库

**接口**: `POST /api/database/restore`

**描述**: 上传备份文件并恢复数据库（会删除所有现有数据）

**请求方式**: `multipart/form-data`

**请求参数**:

| 字段 | 类型 | 必填 | 说明 |
|-----|------|-----|------|
| backup_file | File | 是 | 备份文件（.sql或.sql.gz） |

**响应示例**:

```json
{
  "code": 200,
  "message": "恢复任务已启动，系统进入维护模式",
  "data": null
}
```

**错误响应**:
```json
{
  "code": 400,
  "message": "获取上传文件失败: xxx",
  "data": null
}
```

```json
{
  "code": 400,
  "message": "备份文件过大，最大支持1GB",
  "data": null
}
```

```json
{
  "code": 400,
  "message": "只支持.sql或.sql.gz格式的备份文件",
  "data": null
}
```

```json
{
  "code": 400,
  "message": "备份文件格式无效或已损坏",
  "data": null
}
```

```json
{
  "code": 400,
  "message": "有备份任务正在运行中，无法进行恢复",
  "data": null
}
```

```json
{
  "code": 400,
  "message": "系统已处于维护模式",
  "data": null
}
```

**恢复流程**:
1. 验证文件格式和完整性
2. 自动创建当前数据库的回滚备份
3. 系统进入维护模式
4. 删除所有现有数据
5. 从备份文件恢复数据
6. 恢复成功后自动退出维护模式
7. 如果恢复失败，自动从回滚备份恢复

**前端注意事项**:
1. **必须提供严格的二次确认**，明确告知用户所有数据将被删除
2. 建议输入确认码（如"RESTORE"）来确认操作
3. 显示文件上传进度
4. 上传后显示"正在恢复，请勿关闭页面"
5. 恢复期间禁用所有数据操作功能
6. 监听维护模式状态，恢复完成后刷新页面

---

## 4. 备份文件管理

### 4.1 列出所有备份文件

**接口**: `GET /api/database/backups`

**描述**: 获取所有备份文件列表

**请求参数**: 无

**响应示例**:

```json
{
  "code": 200,
  "message": "获取备份列表成功",
  "data": [
    {
      "filename": "backup_2026-01-23_14-30-00.sql.gz",
      "file_size": 52428800,           // 文件大小（字节）
      "modified_time": 1706000000,     // 修改时间戳
      "backup_type": "manual",         // manual: 手动, auto: 自动
      "created_reason": "手动备份",    // 创建原因
      "table_count": 25,               // 表数量
      "database_size": 104857600       // 数据库大小（字节）
    },
    {
      "filename": "backup_2026-01-22_02-00-00.sql.gz",
      "file_size": 51200000,
      "modified_time": 1705900000,
      "backup_type": "auto",
      "created_reason": "定时自动备份",
      "table_count": 24,
      "database_size": 102400000
    }
  ]
}
```

**文件大小显示建议**:
```javascript
function formatFileSize(bytes) {
  if (bytes === 0) return '0 B';
  const k = 1024;
  const sizes = ['B', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}
```

**前端注意事项**:
1. 按时间倒序显示（最新的在前）
2. 显示备份类型徽章（手动/自动）
3. 显示文件大小、表数量等元数据
4. 提供下载、删除、恢复操作
5. 高亮显示最新的备份

---

### 4.2 删除单个备份文件

**接口**: `DELETE /api/database/backup`

**描述**: 删除指定的备份文件

**请求参数**:

| 参数 | 类型 | 必填 | 说明 |
|-----|------|-----|------|
| filename | string | 是 | 备份文件名（通过query参数传递）|

**请求示例**: `DELETE /api/database/backup?filename=backup_2026-01-23_14-30-00.sql.gz`

**响应示例**:

```json
{
  "code": 200,
  "message": "备份文件已删除",
  "data": null
}
```

**错误响应**:
```json
{
  "code": 400,
  "message": "备份文件不存在",
  "data": null
}
```

**前端注意事项**:
1. 提供二次确认对话框
2. 删除后刷新备份列表
3. 注意：仅删除文件，不删除数据库记录

---

### 4.3 删除备份记录

**接口**: `POST /api/database/backup-record/delete`

**描述**: 删除备份记录（同时删除对应的备份文件和回滚备份）

**请求参数**:

```json
{
  "record_id": 15  // 必填: 备份记录ID
}
```

**响应示例**:

```json
{
  "code": 200,
  "message": "备份记录及相关文件已删除",
  "data": null
}
```

**错误响应**:
```json
{
  "code": 400,
  "message": "备份记录不存在",
  "data": null
}
```

**前端注意事项**:
1. 提供二次确认对话框
2. 此操作会同时删除备份文件和关联的回滚备份
3. 删除后刷新备份记录列表

---

## 5. 备份历史记录

### 5.1 获取备份历史记录

**接口**: `GET /api/database/backup-records`

**描述**: 分页获取备份历史记录

**请求参数**:

| 参数 | 类型 | 必填 | 说明 | 默认值 |
|-----|------|-----|------|--------|
| page | int | 否 | 页码 | 1 |
| page_size | int | 否 | 每页数量 | 10 |

**请求示例**: `GET /api/database/backup-records?page=1&page_size=10`

**响应示例**:

```json
{
  "code": 200,
  "message": "获取备份记录成功",
  "data": {
    "total": 45,  // 总记录数
    "records": [
      {
        "id": 15,
        "task_id": 15,
        "status": "completed",              // completed/cancelled/timeout/failed
        "file_path": "backup_2026-01-23_14-30-00.sql.gz",
        "file_size": 52428800,
        "database_size": 104857600,
        "table_count": 25,
        "backup_duration": 180,             // 备份耗时（秒）
        "backup_type": "manual",            // manual/auto
        "created_reason": "手动备份数据库",
        "failure_reason": "",               // 失败原因（成功时为空）
        "compression_ratio": 0.5,           // 压缩比例
        "is_compressed": 1,                 // 0: 未压缩, 1: 已压缩
        "completed_at": 1706000000,         // 完成时间戳
        "created_at": 1705999820,
        "updated_at": 1706000000
      },
      {
        "id": 14,
        "task_id": 14,
        "status": "failed",
        "file_path": "",
        "file_size": 0,
        "database_size": 0,
        "table_count": 0,
        "backup_duration": 60,
        "backup_type": "auto",
        "created_reason": "定时自动备份",
        "failure_reason": "磁盘空间不足",
        "compression_ratio": 0,
        "is_compressed": 1,
        "completed_at": 1705900000,
        "created_at": 1705899940,
        "updated_at": 1705900000
      }
    ]
  }
}
```

**状态说明**:
- `completed`: 备份成功
- `cancelled`: 用户取消
- `timeout`: 执行超时
- `failed`: 备份失败

**前端注意事项**:
1. 使用分页表格显示
2. 不同状态用不同颜色标识
3. 失败的记录显示失败原因
4. 显示备份耗时、压缩比例等信息
5. 提供筛选功能（按状态、类型）

---

## 6. 维护模式

### 6.1 维护模式说明

维护模式是系统在执行数据库恢复操作时的特殊状态：

**特点**:
- 恢复操作开始时自动进入
- 恢复成功或失败后自动退出
- 最长持续1小时（超时自动退出）
- 应用重启时自动退出

**前端处理建议**:

1. **定期检查维护模式状态**:
   ```javascript
   // 通过获取备份配置接口检查
   const response = await fetch('/api/database/backup-config');
   const data = await response.json();
   const isMaintenanceMode = data.data.config?.maintenance_mode === 1;
   ```

2. **维护模式下的UI处理**:
   - 显示全局维护模式提示横幅
   - 禁用所有数据写入相关功能
   - 显示"系统维护中，请稍候..."消息
   - 可以保留只读功能（查看配置等）

3. **维护模式恢复后**:
   - 显示恢复成功提示
   - 刷新页面重新加载数据
   - 清除维护模式标志

---

## 前端实现建议

### 页面结构

```
数据库备份与恢复
├── 备份配置区
│   ├── 启用/禁用开关
│   ├── 定时备份设置（Cron表达式编辑器）
│   ├── 备份路径配置
│   ├── 保留策略（天数/数量）
│   ├── 压缩选项
│   └── 保存按钮
│
├── 备份操作区
│   ├── 手动备份按钮
│   ├── 备份进度显示（进度条、时间、步骤）
│   └── 取消备份按钮
│
├── 恢复操作区
│   ├── 上传备份文件
│   ├── 文件验证提示
│   └── 恢复按钮（带二次确认）
│
├── 备份文件列表
│   ├── 文件名、大小、时间
│   ├── 备份类型（手动/自动）
│   ├── 操作按钮（恢复、删除）
│   └── 分页控件
│
└── 备份历史记录
    ├── 状态筛选
    ├── 记录列表（状态、时间、耗时）
    └── 分页控件
```

### 关键交互流程

#### 1. 首次配置流程
```
用户访问页面
  ↓
检测到无配置
  ↓
显示配置引导
  ↓
用户填写配置
  ↓
验证并保存
  ↓
启动定时任务
```

#### 2. 手动备份流程
```
点击备份按钮
  ↓
输入备份原因
  ↓
调用启动接口
  ↓
开始轮询进度（每2秒）
  ↓
显示进度条和状态
  ↓
备份完成
  ↓
停止轮询
  ↓
刷新备份列表
  ↓
显示成功提示
```

#### 3. 数据库恢复流程
```
点击恢复按钮
  ↓
上传备份文件
  ↓
显示二次确认对话框
  ↓
用户输入确认码"RESTORE"
  ↓
调用恢复接口
  ↓
显示"恢复中..."遮罩
  ↓
轮询维护模式状态
  ↓
维护模式解除
  ↓
显示成功提示
  ↓
刷新页面
```

### 状态管理

```javascript
// 推荐使用的状态结构
const backupState = {
  config: null,              // 备份配置
  isLoading: false,          // 加载中
  isBackupRunning: false,    // 备份进行中
  backupProgress: null,      // 备份进度
  backupFiles: [],           // 备份文件列表
  backupRecords: [],         // 备份记录
  totalRecords: 0,           // 总记录数
  currentPage: 1,            // 当前页
  pageSize: 10,              // 每页数量
  isMaintenanceMode: false   // 维护模式
};
```

### 错误处理

```javascript
// 统一错误处理
function handleApiError(error, response) {
  if (response?.code === 400) {
    // 业务错误，显示具体消息
    showErrorMessage(response.message);
  } else if (error.name === 'NetworkError') {
    // 网络错误
    showErrorMessage('网络连接失败，请检查网络');
  } else {
    // 其他错误
    showErrorMessage('操作失败，请稍后重试');
  }
}
```

### 用户体验优化

1. **加载状态**: 所有异步操作显示loading指示器
2. **实时反馈**: 操作成功/失败立即显示Toast提示
3. **防重复提交**: 操作期间禁用相关按钮
4. **数据刷新**: 操作完成后自动刷新相关列表
5. **确认对话框**: 危险操作（删除、恢复）必须二次确认
6. **进度可视化**: 备份进度用进度条+百分比+预估时间展示
7. **状态标识**: 不同状态用不同颜色徽章区分
8. **帮助提示**: 关键配置项提供说明文档或Tooltip

### Cron表达式可视化编辑器

建议集成现有的Cron编辑器组件，如：
- `vue-cron-generator`
- `react-cron-generator`
- `cron-builder`

或提供预设选项：
- 每天凌晨2点
- 每周日凌晨
- 每4小时
- 每12小时
- 自定义（手动输入）

---

## 测试建议

### 功能测试用例

1. **配置管理**
   - [ ] 首次创建配置
   - [ ] 更新配置
   - [ ] 无效Cron表达式验证
   - [ ] 小于1小时间隔验证

2. **手动备份**
   - [ ] 启动备份任务
   - [ ] 查询备份进度
   - [ ] 取消备份任务
   - [ ] 并发备份限制

3. **数据库恢复**
   - [ ] 上传并恢复.sql文件
   - [ ] 上传并恢复.sql.gz文件
   - [ ] 无效文件格式验证
   - [ ] 文件大小限制验证
   - [ ] 恢复失败自动回滚

4. **文件管理**
   - [ ] 列出备份文件
   - [ ] 删除备份文件
   - [ ] 删除备份记录

5. **历史记录**
   - [ ] 分页查询
   - [ ] 状态筛选

6. **维护模式**
   - [ ] 恢复时进入维护模式
   - [ ] 维护模式超时自动解除
   - [ ] 重启时自动解除维护模式

### 边界测试

- [ ] 备份文件数量达到上限时的清理
- [ ] 磁盘空间不足时的处理
- [ ] 网络中断时的任务状态
- [ ] 超时任务的自动处理

---

## 常见问题 FAQ

### Q1: 备份文件存储在哪里？
A: 默认存储在 `config/backups/` 目录，可通过配置修改。回滚备份存储在 `config/backups/rollback/` 目录。

### Q2: 备份会影响系统性能吗？
A: 备份是异步操作，不会阻塞HTTP请求。但大型数据库备份期间可能影响数据库性能，建议在业务低峰期执行。

### Q3: 恢复操作可以撤销吗？
A: 恢复前会自动创建回滚备份。如果恢复失败，系统会自动从回滚备份恢复。手动恢复错误的备份后，可以再次使用回滚备份进行恢复。

### Q4: 为什么恢复后需要刷新页面？
A: 恢复操作会删除所有数据并重新导入，可能影响当前用户会话。刷新页面确保数据一致性。

### Q5: 定时备份失败了怎么办？
A: 失败会记录在备份历史中，包含失败原因。可以查看日志定位问题，修复后等待下次定时执行或手动触发备份。

### Q6: 可以同时运行多个备份任务吗？
A: 不可以。系统限制同时只能有一个备份任务运行，确保数据一致性和系统稳定性。

### Q7: 维护模式下哪些功能不可用？
A: 维护模式仅作为状态标识，不在服务端阻塞接口。前端应根据维护模式状态禁用数据写入相关功能。

### Q8: 备份文件可以下载吗？
A: 当前版本未提供下载接口，可以直接访问服务器的备份目录获取文件。后续版本可以添加下载功能。

---

## 版本历史

- **v1.0.0** (2026-01-23): 初始版本
  - 完整的备份和恢复功能
  - 定时自动备份
  - 手动备份和取消
  - 进度监控
  - 备份文件管理
  - 历史记录查询
  - 维护模式支持

---

## 技术支持

如有问题或建议，请联系后端开发团队或提交Issue。
